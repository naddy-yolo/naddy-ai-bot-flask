from flask import Flask, jsonify, request
import os
import requests
from utils.caromil import get_anthropometric_data

app = Flask(__name__)

@app.route('/')
def index():
    return "Flask app is running!"

# âœ… ä½“é‡ãƒ»ä½“è„‚è‚ªãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆPOSTï¼‰
@app.route('/test-caromil', methods=["POST"])
def test_caromil():
    try:
        access_token = os.getenv("CAROMIL_ACCESS_TOKEN")
        if not access_token:
            raise Exception("CAROMIL_ACCESS_TOKEN ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")

        data = request.get_json(force=True)
        start_date = data.get("start_date")
        end_date = data.get("end_date")
        unit = data.get("unit", "day")

        if not start_date or not end_date:
            raise Exception("start_date, end_date ã¯å¿…é ˆã§ã™")

        print(f"ğŸ“… Fetching data from {start_date} to {end_date} with unit '{unit}'")

        result = get_anthropometric_data(
            access_token=access_token,
            start_date=start_date,
            end_date=end_date,
            unit=unit
        )

        return jsonify({"status": "ok", "result": result})

    except Exception as e:
        print("âŒ Error in /test-caromil:", str(e))
        return jsonify({"status": "error", "message": str(e)}), 400

# âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼åŸºæœ¬æƒ…å ±å–å¾—ï¼ˆGETï¼‰
@app.route("/test-userinfo", methods=["GET"])
def test_userinfo():
    try:
        access_token = os.getenv("CAROMIL_ACCESS_TOKEN")
        if not access_token:
            raise Exception("CAROMIL_ACCESS_TOKEN ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")

        url = "https://test-connect.calomeal.com/api/user_info"
        headers = {
            "Authorization": f"Bearer {access_token}",
            "Content-Type": "application/json"
        }

        response = requests.post(url, headers=headers)

        if response.status_code == 200:
            return jsonify({"status": "ok", "result": response.json()})
        else:
            return jsonify({
                "status": "error",
                "message": f"ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—å¤±æ•—: {response.status_code}",
                "response": response.text
            }), response.status_code

    except Exception as e:
        return jsonify({"status": "error", "message": str(e)}), 400

# âœ… èªè¨¼ã‚³ãƒ¼ãƒ‰å—ã‘å–ã‚Š
@app.route("/callback")
def callback():
    code = request.args.get("code")
    state = request.args.get("state")

    if code:
        return f"""
        âœ… èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ã—ã¾ã—ãŸï¼<br>
        <strong>code:</strong> {code}<br>
        <strong>state:</strong> {state or 'ï¼ˆæœªæŒ‡å®šï¼‰'}
        """
    else:
        return "âŒ èªè¨¼ã‚³ãƒ¼ãƒ‰ï¼ˆcodeï¼‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ", 400

if __name__ == '__main__':
    app.run(debug=True)
